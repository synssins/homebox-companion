name: Deploy to homelab

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy latest code and restart service
        run: |
          set -e
          cd /home/homebox/homebox-app
          
          echo "=== Pulling latest code ==="
          git fetch origin
          git reset --hard origin/main
          echo "Current commit: $(git rev-parse --short HEAD)"
          echo "Commit message: $(git log -1 --pretty=%B)"
          
          echo "=== Updating Python dependencies ==="
          uv sync
          
          echo "=== Building frontend ==="
          cd frontend
          npm ci
          npm run build
          
          # Verify build output exists
          if [ ! -d "build" ]; then
            echo "ERROR: Frontend build directory not found!"
            exit 1
          fi
          echo "Frontend build size: $(du -sh build | cut -f1)"
          
          echo "=== Copying frontend to server/static ==="
          mkdir -p ../server/static
          rm -rf ../server/static/*
          cp -r build/* ../server/static/
          cd ..
          
          # Verify static files exist
          if [ ! -f "server/static/index.html" ]; then
            echo "ERROR: server/static/index.html not found after copy!"
            exit 1
          fi
          echo "Static files deployed: $(ls -la server/static/ | head -10)"
          
          echo "=== Restarting service ==="
          sudo systemctl restart homebox-vision.service
          echo "=== Deployment complete ==="

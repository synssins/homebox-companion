name: Deploy to homelab

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy latest code and restart service
        run: |
          set -e
          cd /home/homebox/homebox-app
          
          # Pull latest main
          git fetch origin
          git reset --hard origin/main
          
          # Update Python dependencies
          uv sync
          
          # Build frontend
          cd frontend
          npm ci
          npm run build
          
          # Copy built frontend to server/static
          mkdir -p ../server/static
          rm -rf ../server/static/*
          cp -r build/* ../server/static/
          cd ..
          
          # Restart the app
          sudo systemctl restart homebox-vision.service

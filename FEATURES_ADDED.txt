================================================================================
HOMEBOX-COMPANION FORK - FEATURES ADDED (v2.2.0 Enhancement Branch)
================================================================================

This document describes all features added to the Homebox-Companion fork since
branching from upstream version 2.2.0. These changes enhance the application
for personal use while maintaining backward compatibility with the original.

Base Version: upstream/main @ 2.2.0 (commit 42f3500)
Enhancement Branch: dev-v2.2.0 (28 commits ahead)
Last Updated: 2026-01-06

================================================================================
TABLE OF CONTENTS
================================================================================

1. Multi-Provider AI Configuration
2. Local AI (Ollama) Integration
3. Duplicate Detection by Serial Number
4. In-App Settings (No YAML Required)
5. Grouped Image Detection
6. Crash Recovery Foundation (Partial)
7. Bug Fixes and Stability Improvements
8. Remaining TODOs / Planned Features

================================================================================
1. MULTI-PROVIDER AI CONFIGURATION
================================================================================

WHAT IT DOES:
-------------
Allows users to configure and switch between multiple AI providers (OpenAI,
Anthropic/Claude, Ollama) directly from the Settings page without editing
configuration files or environment variables.

KEY FEATURES:
- Configure API keys for OpenAI and Anthropic in the UI
- Enable/disable individual providers with toggle switches
- Visual badge showing which AI provider is currently active
- Test Connection button to verify provider setup before saving
- Automatic provider selection based on what's enabled and available
- Secure API key handling (keys are masked, never logged)

BENEFITS:
- No need to edit docker-compose.yml or .env files to change AI providers
- Easy switching between cloud AI (when internet available) and local AI
- Clear visibility into which provider is processing your requests
- Reduced configuration errors through UI validation

FILES ADDED/MODIFIED:
- frontend/src/lib/components/settings/AIProviderSection.svelte (NEW)
- frontend/src/lib/api/aiConfig.ts (NEW)
- server/api/ai_config.py (NEW)
- server/schemas/ai_config.py (NEW)

HOW TO USE:
1. Go to Settings page
2. Click "AI Provider" section
3. Enter API keys for desired providers
4. Toggle ON the providers you want available
5. Click "Save Configuration"
6. Active provider shown in badge (e.g., "Ollama", "OpenAI", "Anthropic")

================================================================================
2. LOCAL AI (OLLAMA) INTEGRATION
================================================================================

WHAT IT DOES:
-------------
Adds support for Ollama as a local AI backend, allowing completely private,
offline image analysis without sending data to cloud services.

KEY FEATURES:
- Configure Ollama connection URL in Settings
- Select from available vision models (minicpm-v, llava, etc.)
- Automatic model detection from connected Ollama instance
- GPU detection and status display
- Falls back gracefully if Ollama unavailable

BENEFITS:
- Complete privacy - images never leave your network
- No API costs - unlimited analysis after setup
- Works offline - no internet required
- Faster for bulk operations (no API rate limits)

FILES ADDED/MODIFIED:
- frontend/src/lib/api/ollama.ts (NEW)
- src/homebox_companion/providers/ollama.py (NEW)
- src/homebox_companion/services/gpu_detector.py (NEW)
- src/homebox_companion/services/ollama_manager.py (NEW)
- src/homebox_companion/routes/ollama.py (NEW)

HOW TO USE:
1. Install Ollama on your network (docker or native)
2. Pull a vision model: `ollama pull minicpm-v`
3. Go to Settings > AI Provider
4. Enable Ollama and enter URL (e.g., http://192.168.1.100:11434)
5. Select vision model from dropdown
6. Save - Ollama will now be used for image analysis

RECOMMENDED MODELS:
- minicpm-v: Best balance of speed and accuracy
- llava: Good alternative, widely supported
- llava-phi3: Smaller, faster, less accurate

================================================================================
3. DUPLICATE DETECTION BY SERIAL NUMBER
================================================================================

WHAT IT DOES:
-------------
Warns you when scanned items have serial numbers matching items already in
your Homebox inventory. This prevents accidentally creating duplicate entries.

KEY FEATURES:
- Builds an index of all serial numbers in your Homebox inventory
- Checks newly scanned items against the index during review
- Shows warning banner on items with matching serial numbers
- Non-blocking - you can still add items if desired (e.g., replacement parts)
- Persistent index survives container restarts
- Differential updates - only fetches new items, not entire inventory
- Manual "Rebuild Index" button in Settings

BENEFITS:
- Avoid duplicate inventory entries
- Quickly identify if you're re-scanning something you already have
- Saves time during bulk scanning sessions
- Index persists between sessions (no re-building on restart)

FILES ADDED/MODIFIED:
- src/homebox_companion/services/duplicate_detector.py (NEW)
- server/api/items.py (MODIFIED - added endpoints)
- server/schemas/items.py (MODIFIED - added schemas)
- frontend/src/lib/components/DuplicateWarningBanner.svelte (NEW)
- frontend/src/lib/api/items.ts (MODIFIED - added checkDuplicates)

HOW TO USE:
1. Go to Settings > Behavior Settings
2. Enable "Duplicate Detection by Serial Number"
3. Click "Rebuild Index" to build initial index (one-time)
4. During scan workflow, items with matching serials show warning
5. Choose to skip or add anyway based on your needs

DISPLAY:
- Yellow warning banner: "May be duplicate - matches [Item Name] (Serial: XXX)"
- Shows during review phase for each item
- Shows summary on confirmation page

================================================================================
4. IN-APP SETTINGS (NO YAML REQUIRED)
================================================================================

WHAT IT DOES:
-------------
Moves configuration from environment variables and YAML files into the
application UI, making setup and changes much simpler.

KEY FEATURES:

A) Connection Settings:
   - Homebox URL override (instead of HBC_HOMEBOX_URL env var)
   - Image quality setting (instead of HBC_IMAGE_QUALITY env var)
   - Changes take effect immediately without restart

B) Behavior Settings:
   - Enable/disable duplicate detection
   - More toggles planned for future features

C) AI Provider Settings:
   - All AI configuration in UI (see section 1 above)

BENEFITS:
- Simpler Docker deployment - just mount volumes, no env vars needed
- Non-technical users can configure without editing YAML
- Changes don't require container restart
- Settings persist in application data directory

FILES ADDED/MODIFIED:
- frontend/src/lib/components/settings/ConnectionSection.svelte (NEW)
- frontend/src/lib/components/settings/BehaviorSection.svelte (NEW)
- frontend/src/lib/api/appPreferences.ts (NEW)
- server/api/settings.py (MODIFIED)
- server/schemas/settings.py (MODIFIED)
- src/homebox_companion/models/app_preferences.py (NEW)

HOW TO USE:
1. Deploy container with minimal configuration
2. Go to Settings page in browser
3. Configure Homebox URL, AI providers, behaviors as needed
4. Settings saved automatically

SIMPLIFIED DOCKER DEPLOYMENT:
```yaml
# Before (required many env vars):
services:
  companion:
    image: homebox-companion
    environment:
      - HBC_HOMEBOX_URL=http://homebox:7745
      - HBC_LLM_API_KEY=sk-xxx
      - HBC_IMAGE_QUALITY=high
      - HBC_MODEL=gpt-4o

# After (just volumes):
services:
  companion:
    image: homebox-companion
    volumes:
      - companion-data:/data
    # Configure everything in the UI!
```

================================================================================
5. GROUPED IMAGE DETECTION
================================================================================

WHAT IT DOES:
-------------
New API endpoint that uses AI to automatically group multiple images showing
the same physical item. Instead of detecting items per-image, it analyzes all
images together and identifies which ones show the same thing.

KEY FEATURES:
- POST /api/vision/detect-grouped endpoint
- AI analyzes all images and groups by physical item
- Returns detected items with image_indices showing which images belong
- Useful for uploading front/back/detail photos of the same item

BENEFITS:
- Upload multiple angles of one item, get one inventory entry
- AI determines grouping (not just filename matching)
- Reduces manual merging during review

FILES ADDED/MODIFIED:
- src/homebox_companion/routes/vision.py (MODIFIED)
- src/homebox_companion/services/detector.py (MODIFIED)
- src/homebox_companion/prompts.py (MODIFIED - new grouped prompts)
- server/schemas/vision.py (MODIFIED)

STATUS: Backend complete, frontend integration pending (see TODOs)

================================================================================
6. CRASH RECOVERY FOUNDATION (PARTIAL)
================================================================================

WHAT IT DOES:
-------------
Backend infrastructure for session-based state management that can survive
application crashes and container restarts.

KEY FEATURES IMPLEMENTED:
- Session data models
- Session API endpoints (/api/sessions/*)
- Recovery banner component (frontend)
- State persistence to disk

BENEFITS:
- Never lose work if app crashes during bulk scanning
- Resume interrupted sessions
- Track progress across container restarts

FILES ADDED:
- src/homebox_companion/services/state_manager.py (NEW)
- src/homebox_companion/models/session.py (NEW)
- src/homebox_companion/routes/sessions.py (NEW)
- frontend/src/lib/api/sessions.ts (NEW)
- frontend/src/lib/components/RecoveryBanner.svelte (NEW)

STATUS: Infrastructure in place, full integration pending (see TODOs)

================================================================================
7. BUG FIXES AND STABILITY IMPROVEMENTS
================================================================================

A) UI Freeze Prevention (Svelte 5 $effect Loops)
------------------------------------------------
PROBLEM: Certain actions (saving AI config, skipping last review item) would
cause the browser tab to become completely unresponsive.

CAUSE: Svelte 5's $effect() rune can cause infinite loops when the effect
modifies state that it also reads.

FIX: Implemented state transition detection pattern - track previous state
and only act on actual transitions, not repeated reads.

FILES FIXED:
- frontend/src/routes/settings/+page.svelte
- frontend/src/routes/review/+page.svelte

B) API Response Handling
------------------------
PROBLEM: Duplicate detection failing with 500 error.

CAUSE: Homebox API returns paginated responses {items: [...], page, total}
but code was treating the entire response as the items array.

FIX: Extract items array from paginated response.

FILES FIXED:
- src/homebox_companion/services/duplicate_detector.py

C) Asset ID Parsing
-------------------
PROBLEM: TypeError when comparing asset IDs.

CAUSE: Homebox returns asset IDs as formatted strings ("000-004") not integers.

FIX: Added parse_asset_id() helper to handle both formats.

FILES FIXED:
- src/homebox_companion/services/duplicate_detector.py

D) Skip on Last Item
--------------------
PROBLEM: Clicking "Skip" on the last review item did nothing.

CAUSE: Navigation logic wasn't handling the "all items skipped" case.

FIX: Added status change watcher with proper transition detection to navigate
back to capture page with informative message.

FILES FIXED:
- frontend/src/routes/review/+page.svelte
- frontend/src/lib/workflows/scan.svelte.ts
- frontend/src/lib/workflows/review.svelte.ts

================================================================================
8. REMAINING TODOS / PLANNED FEATURES
================================================================================

HIGH PRIORITY:
--------------
[ ] Enrichment Service - Web lookup for product specs (MSRP, features)
    - Would enhance descriptions for insurance documentation
    - Privacy controls needed (serial numbers never sent)

[ ] Full Crash Recovery Integration
    - Connect session state to actual workflow
    - Show recovery banner when interrupted session detected
    - One-click resume from where you left off

[ ] Grouped Detection Frontend
    - UI for the grouped detection endpoint
    - Drag-to-group/ungroup interface
    - Visual grouping indicators

MEDIUM PRIORITY:
----------------
[ ] Clipboard Paste Support
    - Ctrl+V / Cmd+V to paste images
    - Useful for screenshots of labels/receipts

[ ] Photo Grouping UI
    - Manual grouping during review
    - Merge multiple items into one

[ ] GPU Settings Display
    - Show detected GPU in Settings
    - Toggle GPU acceleration on/off

LOW PRIORITY:
-------------
[ ] Embedded Ollama Docker Image
    - Single container with Ollama built-in
    - Model pre-loading at build time

[ ] Air-gapped Deployment Mode
    - No external network calls at all
    - Pre-bundled models

================================================================================
TECHNICAL NOTES FOR MAINTAINER
================================================================================

BACKWARD COMPATIBILITY:
- All existing environment variables still work
- No breaking changes to existing API endpoints
- New features are opt-in, not mandatory
- Existing Docker deployments continue to work

ARCHITECTURE CHANGES:
- Added services layer (src/homebox_companion/services/)
- Added providers layer (src/homebox_companion/providers/)
- Refactored frontend state management (workflows/*.svelte.ts)
- Settings page restructured with collapsible sections

DEPENDENCIES ADDED:
- None in backend (uses existing httpx, pydantic)
- None in frontend (uses existing Svelte, TypeScript)

TESTING:
- Unit tests added for duplicate_detector
- Frontend type checking passes (npm run check)
- Manual testing on full capture → review → submit workflow

================================================================================
END OF DOCUMENT
================================================================================

*Generated by Claude AI*

# Homebox-Companion Architecture Guide

A developer's guide to understanding and navigating the codebase.

---

## Directory Overview

```
homebox-companion/
├── server/                     # FastAPI routes (HTTP layer)
├── src/homebox_companion/      # Core business logic (Python)
├── frontend/                   # SvelteKit UI
├── tests/                      # Test suite
├── Dockerfile                  # Container build
└── docker-compose.yml          # Local deployment
```

---

## Backend Architecture

The backend is split into two directories:

| Directory | Purpose |
|-----------|---------|
| `server/` | HTTP routes, request/response handling |
| `src/homebox_companion/` | Business logic, services, providers |

### server/ - API Routes

FastAPI route handlers. Each file handles one area of functionality.

```
server/
├── api/
│   ├── ai_config.py        # GET/PUT /api/ai-config, POST /api/ai/test-connection
│   ├── app_preferences.py  # GET/PUT /api/preferences
│   ├── auth.py             # POST /api/auth/login, /api/auth/logout
│   ├── chat.py             # WebSocket /api/chat, POST /api/chat/approve
│   ├── config.py           # GET /api/config (homebox URL, features)
│   ├── debug.py            # GET /api/debug/* (logging, diagnostics)
│   ├── enrichment.py       # POST /api/enrichment/lookup
│   ├── field_preferences.py# GET/PUT /api/field-preferences
│   ├── items.py            # POST /api/items, /api/items/{id}/merge
│   ├── labels.py           # GET /api/labels
│   ├── locations.py        # GET /api/locations, POST /api/locations
│   ├── logs.py             # GET /api/logs (server-sent events)
│   ├── ollama.py           # GET /api/ollama/models, /api/ollama/status
│   ├── sessions.py         # GET/POST /api/sessions (crash recovery)
│   └── tools/
│       └── vision.py       # POST /api/vision/analyze (main AI endpoint)
├── schemas/                # Pydantic request/response models
├── app.py                  # FastAPI app factory, router mounting
├── dependencies.py         # Dependency injection (get_homebox_client, etc.)
└── middleware.py           # CORS, error handling
```

### src/homebox_companion/ - Core Logic

Business logic, organized by domain.

```
src/homebox_companion/
├── ai/                     # AI/LLM utilities
│   ├── images.py           # Image encoding, resizing
│   ├── llm.py              # LLM client wrapper
│   ├── model_capabilities.py # Model feature detection
│   └── prompts.py          # Prompt templates
│
├── chat/                   # Chat assistant feature
│   ├── orchestrator.py     # Main chat logic
│   ├── llm_client.py       # Chat-specific LLM handling
│   ├── approvals.py        # Destructive action approval flow
│   ├── session.py          # Chat session state
│   ├── store.py            # Chat history persistence
│   └── stream.py           # Streaming response handling
│
├── core/                   # Configuration & infrastructure
│   ├── ai_config.py        # AI provider configuration model
│   ├── app_preferences.py  # User preferences model
│   ├── config.py           # Environment settings (Settings class)
│   ├── exceptions.py       # Custom exception types
│   ├── field_preferences.py# Per-field AI extraction preferences
│   ├── logging.py          # Logging configuration
│   └── rate_limiter.py     # API rate limiting
│
├── homebox/                # Homebox API client
│   ├── client.py           # HomeboxClient class (all Homebox API calls)
│   ├── models.py           # Homebox data models (Item, Location, Label)
│   └── views.py            # Response transformations
│
├── models/                 # Data models
│   └── session.py          # Capture session model
│
├── providers/              # AI provider implementations
│   ├── litellm_provider.py # OpenAI/Anthropic via LiteLLM
│   └── ollama.py           # Ollama local AI
│
├── services/               # Business services
│   ├── debug_logger.py     # Real-time log streaming
│   ├── duplicate_detector.py # Multi-strategy duplicate detection
│   ├── enrichment.py       # Product spec enrichment orchestrator
│   ├── gpu_detector.py     # GPU availability detection
│   ├── ollama_manager.py   # Ollama process management
│   ├── state_manager.py    # Session state persistence
│   └── search_providers/   # Web search for enrichment
│       ├── base.py         # Abstract search provider
│       ├── google_cse.py   # Google Custom Search
│       ├── searxng.py      # SearXNG instance
│       └── tavily.py       # Tavily API
│
└── tools/vision/           # Vision analysis pipeline
    ├── analyzer.py         # Main analysis orchestrator
    ├── corrector.py        # AI correction handling
    ├── detector.py         # Item detection from images
    ├── models.py           # Vision data models
    └── prompts.py          # Vision-specific prompts
```

---

## Frontend Architecture

SvelteKit application with Svelte 5 runes.

```
frontend/src/
├── routes/                 # Pages (file-based routing)
├── lib/
│   ├── api/                # Backend API clients
│   ├── components/         # Reusable UI components
│   ├── stores/             # Global reactive state
│   ├── workflows/          # Page-specific state machines
│   ├── actions/            # Svelte actions (DOM behaviors)
│   ├── utils/              # Helper functions
│   └── types/              # TypeScript interfaces
├── app.html                # HTML shell
├── app.css                 # Global styles (Tailwind + DaisyUI)
└── app.d.ts                # Type declarations
```

### routes/ - Pages

Each folder is a route. `+page.svelte` is the page component.

| Route | Purpose |
|-------|---------|
| `/` | Login page |
| `/location` | Location selection (tree browser, search, QR scan) |
| `/capture` | Photo capture and AI analysis |
| `/review` | Review/edit detected items one by one |
| `/summary` | Final review of all items before submit |
| `/success` | Success confirmation after submit |
| `/settings` | All configuration (AI, behavior, enrichment) |
| `/chat` | Chat assistant interface |
| `/grouping` | Photo grouping UI (experimental) |

### lib/api/ - API Clients

Each file wraps one area of the backend API.

| File | Backend Routes |
|------|----------------|
| `auth.ts` | `/api/auth/*` |
| `aiConfig.ts` | `/api/ai-config`, `/api/ai/test-connection` |
| `appPreferences.ts` | `/api/preferences` |
| `enrichment.ts` | `/api/enrichment/*` |
| `items.ts` | `/api/items`, `/api/items/{id}/merge` |
| `labels.ts` | `/api/labels` |
| `locations.ts` | `/api/locations` |
| `ollama.ts` | `/api/ollama/*` |
| `sessions.ts` | `/api/sessions` |
| `vision.ts` | `/api/vision/analyze` |

### lib/components/ - UI Components

Organized by feature area.

```
components/
├── settings/               # Settings page sections
│   ├── AboutSection.svelte
│   ├── AccountSection.svelte
│   ├── AIConfigurationSection.svelte   # Main AI settings container
│   ├── AIProviderSection.svelte        # Provider cards (Ollama, OpenAI, etc.)
│   ├── AIProviderSubSection.svelte     # Individual provider config
│   ├── BehaviorSection.svelte          # Duplicate detection, token usage
│   ├── ConnectionSection.svelte        # Homebox URL
│   ├── EnrichmentSection.svelte        # Product enrichment config
│   └── ThemeSection.svelte             # Theme selection
│
├── form/                   # Form components for item editing
│   ├── ItemCoreFields.svelte           # Name, description, quantity
│   ├── ItemExtendedFields.svelte       # Manufacturer, model, serial, price
│   ├── LabelSelector.svelte            # Label picker
│   └── LocationSelector.svelte         # Location picker
│
├── DuplicateWarningBanner.svelte       # Duplicate detection UI
├── ImagesPanel.svelte                  # Photo gallery/management
├── ThumbnailEditor.svelte              # Crop tool for thumbnails
├── TokenUsageDisplay.svelte            # AI token consumption display
├── QrScanner.svelte                    # QR code scanner
├── RecoveryBanner.svelte               # Session recovery prompt
└── ...                                 # Many more UI components
```

### lib/workflows/ - State Management

Each workflow manages state for one page/flow. Uses Svelte 5 `$state` runes.

| File | Page | Responsibilities |
|------|------|------------------|
| `scan.svelte.ts` | All capture flow | Photos, detected items, current item index, duplicate decisions |
| `capture.svelte.ts` | `/capture` | Camera state, image handling |
| `analysis.svelte.ts` | `/capture` | AI analysis progress, results |
| `review.svelte.ts` | `/review` | Current item editing state |
| `submission.svelte.ts` | `/summary` | Submit progress, results |
| `settings.svelte.ts` | `/settings` | Settings form state |

### lib/stores/ - Global State

Persistent state shared across pages.

| File | Purpose |
|------|---------|
| `auth.svelte.ts` | Login state, token management |
| `labels.svelte.ts` | Cached labels from Homebox |
| `locations.svelte.ts` | Cached locations, current location |
| `theme.svelte.ts` | Current theme |
| `ui.svelte.ts` | UI state (loading, errors) |
| `chat.svelte.ts` | Chat session state |

---

## Feature Map

Where to find the code for each feature:

### Multi-Provider AI

| Layer | Files |
|-------|-------|
| Config model | `src/homebox_companion/core/ai_config.py` |
| Providers | `src/homebox_companion/providers/litellm_provider.py`, `ollama.py` |
| API routes | `server/api/ai_config.py`, `server/api/ollama.py` |
| Frontend config | `frontend/src/lib/components/settings/AIProviderSection.svelte` |
| Frontend API | `frontend/src/lib/api/aiConfig.ts` |

### Duplicate Detection

| Layer | Files |
|-------|-------|
| Detection logic | `src/homebox_companion/services/duplicate_detector.py` |
| API integration | `server/api/items.py` (check on create/merge) |
| Frontend display | `frontend/src/lib/components/DuplicateWarningBanner.svelte` |
| State management | `frontend/src/lib/workflows/scan.svelte.ts` (updateDecisions) |

### Product Enrichment

| Layer | Files |
|-------|-------|
| Orchestrator | `src/homebox_companion/services/enrichment.py` |
| Search providers | `src/homebox_companion/services/search_providers/*.py` |
| API routes | `server/api/enrichment.py` |
| Frontend config | `frontend/src/lib/components/settings/EnrichmentSection.svelte` |
| Frontend trigger | `frontend/src/lib/api/enrichment.ts` |

### Vision Analysis (AI Item Detection)

| Layer | Files |
|-------|-------|
| Analysis pipeline | `src/homebox_companion/tools/vision/analyzer.py` |
| Item detection | `src/homebox_companion/tools/vision/detector.py` |
| AI correction | `src/homebox_companion/tools/vision/corrector.py` |
| Prompts | `src/homebox_companion/tools/vision/prompts.py` |
| API route | `server/api/tools/vision.py` |
| Frontend trigger | `frontend/src/lib/api/vision.ts` |
| Frontend state | `frontend/src/lib/workflows/analysis.svelte.ts` |

### Item Submission

| Layer | Files |
|-------|-------|
| Homebox client | `src/homebox_companion/homebox/client.py` |
| Create/merge routes | `server/api/items.py` |
| Frontend API | `frontend/src/lib/api/items.ts` |
| Submission state | `frontend/src/lib/workflows/submission.svelte.ts` |
| Summary page | `frontend/src/routes/summary/+page.svelte` |

### Chat Assistant

| Layer | Files |
|-------|-------|
| Orchestrator | `src/homebox_companion/chat/orchestrator.py` |
| LLM client | `src/homebox_companion/chat/llm_client.py` |
| Approvals | `src/homebox_companion/chat/approvals.py` |
| WebSocket route | `server/api/chat.py` |
| Frontend page | `frontend/src/routes/chat/+page.svelte` |
| Frontend state | `frontend/src/lib/stores/chat.svelte.ts` |

### Settings

| Layer | Files |
|-------|-------|
| App preferences | `src/homebox_companion/core/app_preferences.py` |
| AI config | `src/homebox_companion/core/ai_config.py` |
| API routes | `server/api/app_preferences.py`, `server/api/ai_config.py` |
| Frontend page | `frontend/src/routes/settings/+page.svelte` |
| Settings sections | `frontend/src/lib/components/settings/*.svelte` |

---

## Data Flow

### Photo Capture → Item Creation

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Capture   │───▶│   Analyze   │───▶│   Review    │───▶│   Submit    │
│    Page     │    │  (AI call)  │    │    Page     │    │   Summary   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
      │                  │                  │                  │
      ▼                  ▼                  ▼                  ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ capture.ts  │    │ vision.ts   │    │ review.ts   │    │submission.ts│
│ (workflow)  │    │ (API call)  │    │ (workflow)  │    │ (workflow)  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                         │                                      │
                         ▼                                      ▼
                   ┌─────────────┐                        ┌─────────────┐
                   │ /api/vision │                        │ /api/items  │
                   │  /analyze   │                        │   (POST)    │
                   └─────────────┘                        └─────────────┘
                         │                                      │
                         ▼                                      ▼
                   ┌─────────────┐                        ┌─────────────┐
                   │  analyzer   │                        │  Homebox    │
                   │  + LLM      │                        │    API      │
                   └─────────────┘                        └─────────────┘
```

### AI Provider Selection

```
Request with images
       │
       ▼
┌─────────────────┐
│ Get active      │
│ provider from   │
│ ai_config.json  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
 Ollama    LiteLLM
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│Local  │ │OpenAI/│
│Model  │ │Anthro │
└───────┘ └───────┘
    │         │
    └────┬────┘
         │
    On failure + fallback enabled?
         │
    ┌────┴────┐
    │         │
   Yes       No
    │         │
    ▼         ▼
  Retry     Return
  with      error
  backup
```

---

## Configuration Files

Runtime configuration stored in `/data` volume:

| File | Purpose | Managed By |
|------|---------|------------|
| `app_preferences.json` | Homebox URL, behavior settings | `app_preferences.py` |
| `ai_config.json` | AI provider settings, API keys | `ai_config.py` |
| `field_preferences.json` | Per-field extraction settings | `field_preferences.py` |
| `enrichment_cache.json` | Cached product lookups | `enrichment.py` |
| `duplicate_index.json` | Serial number index | `duplicate_detector.py` |

---

## Adding New Features

### Adding a New API Endpoint

1. Create schema in `server/schemas/your_feature.py`
2. Create route in `server/api/your_feature.py`
3. Register router in `server/app.py`
4. Add API client in `frontend/src/lib/api/yourFeature.ts`
5. Export from `frontend/src/lib/api/index.ts`

### Adding a New Settings Section

1. Create component `frontend/src/lib/components/settings/YourSection.svelte`
2. Add to `frontend/src/routes/settings/+page.svelte`
3. Add preferences to `src/homebox_companion/core/app_preferences.py`
4. Add API route if needed in `server/api/app_preferences.py`

### Adding a New AI Provider

1. Create provider in `src/homebox_companion/providers/your_provider.py`
2. Implement `complete()` and `test_connection()` methods
3. Add to provider selection in `src/homebox_companion/core/ai_config.py`
4. Add UI config in `frontend/src/lib/components/settings/AIProviderSubSection.svelte`

### Adding a New Service

1. Create service in `src/homebox_companion/services/your_service.py`
2. Add dependency in `server/dependencies.py` if needed
3. Create API route in `server/api/your_feature.py`
4. Wire up frontend as needed

---

## Key Patterns

### Backend Dependency Injection

```python
# server/dependencies.py
def get_homebox_client(request: Request) -> HomeboxClient:
    return HomeboxClient(token=request.state.token)

# server/api/items.py
@router.post("/items")
async def create_item(
    item: CreateItemRequest,
    client: HomeboxClient = Depends(get_homebox_client)
):
    return await client.create_item(item)
```

### Frontend Workflow State

```typescript
// frontend/src/lib/workflows/example.svelte.ts
class ExampleWorkflow {
    private _items = $state<Item[]>([]);
    private _loading = $state(false);

    get items() { return this._items; }
    get loading() { return this._loading; }

    async load() {
        this._loading = true;
        this._items = await api.items.list();
        this._loading = false;
    }
}

export const exampleWorkflow = new ExampleWorkflow();
```

### Frontend API Client

```typescript
// frontend/src/lib/api/example.ts
import { client } from './client';

export const example = {
    async list(): Promise<Item[]> {
        const response = await client.get('/api/example');
        return response.json();
    },

    async create(data: CreateRequest): Promise<Item> {
        const response = await client.post('/api/example', { body: data });
        return response.json();
    }
};
```

---

## Testing

```bash
# Run all tests
pytest tests/ -v

# Run specific test file
pytest tests/unit/test_duplicate_detector.py -v

# Run with coverage
pytest tests/ --cov=homebox_companion --cov-report=html
```

---

## Quick Reference

| I want to... | Look in... |
|--------------|------------|
| Change how AI detects items | `src/homebox_companion/tools/vision/` |
| Add a new Homebox API call | `src/homebox_companion/homebox/client.py` |
| Modify duplicate detection | `src/homebox_companion/services/duplicate_detector.py` |
| Add enrichment source | `src/homebox_companion/services/search_providers/` |
| Change settings UI | `frontend/src/lib/components/settings/` |
| Modify review page | `frontend/src/routes/review/+page.svelte` |
| Change capture flow state | `frontend/src/lib/workflows/scan.svelte.ts` |
| Add new API endpoint | `server/api/` + `frontend/src/lib/api/` |
| Modify AI prompts | `src/homebox_companion/tools/vision/prompts.py` |

# Demo Deployment - Combined Homebox + Homebox-Companion Container
#
# This Dockerfile creates a single container running both:
#   - Homebox (port 7745 internal)
#   - Homebox Companion (port 8000 exposed)
#
# Uses s6-overlay for process supervision and includes a cron job
# to reset the demo database every 30 minutes.
#
# Build:   docker build -f demo/Dockerfile.demo -t homebox-companion-demo .
# Run:     docker run -p 8000:8000 -e HBC_LLM_API_KEY=sk-xxx homebox-companion-demo

# =============================================================================
# Stage 1: Build homebox-companion frontend
# =============================================================================
FROM node:20-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci --silent --no-progress 2>/dev/null
COPY frontend/ ./
RUN npm run build --silent 2>/dev/null

# =============================================================================
# Stage 2: Final image with s6-overlay, Homebox, and homebox-companion
# =============================================================================
FROM python:3.12-alpine

# s6-overlay version
ARG S6_OVERLAY_VERSION=3.2.0.0

# Install s6-overlay
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_OVERLAY_VERSION}/s6-overlay-noarch.tar.xz /tmp
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_OVERLAY_VERSION}/s6-overlay-x86_64.tar.xz /tmp
RUN apk add --no-cache xz \
    && tar -C / -Jxpf /tmp/s6-overlay-noarch.tar.xz \
    && tar -C / -Jxpf /tmp/s6-overlay-x86_64.tar.xz \
    && rm /tmp/s6-overlay-*.tar.xz

# Install runtime dependencies
RUN apk add --no-cache \
    curl \
    wget \
    ca-certificates \
    sqlite \
    bash \
    supercronic

# Download Homebox binary from latest release
ARG HOMEBOX_VERSION=0.16.1
RUN wget -q "https://github.com/sysadminsmedia/homebox/releases/download/v${HOMEBOX_VERSION}/homebox_Linux_x86_64.tar.gz" -O /tmp/homebox.tar.gz \
    && tar -xzf /tmp/homebox.tar.gz -C /tmp \
    && mv /tmp/homebox /usr/local/bin/homebox \
    && chmod +x /usr/local/bin/homebox \
    && rm /tmp/homebox.tar.gz

# Create directories
RUN mkdir -p /app /data /var/log/services

# Install uv for Python dependency management
RUN pip install --no-cache-dir -q uv

# Copy Python project files
WORKDIR /app
COPY pyproject.toml uv.lock ./
COPY src/ ./src/
COPY server/ ./server/
COPY demo/ ./demo/

# Install Python dependencies
RUN uv sync --no-dev --quiet

# Copy built frontend
COPY --from=frontend-builder /app/frontend/build ./server/static/

# =============================================================================
# s6-overlay Service Definitions
# =============================================================================

# --- Homebox Service ---
RUN mkdir -p /etc/s6-overlay/s6-rc.d/homebox \
    && echo "longrun" > /etc/s6-overlay/s6-rc.d/homebox/type \
    && printf '#!/command/execlineb -P\nforeground { mkdir -p /data }\n/usr/local/bin/homebox /data/config.yml\n' > /etc/s6-overlay/s6-rc.d/homebox/run \
    && chmod +x /etc/s6-overlay/s6-rc.d/homebox/run

# --- Homebox Companion Service ---
RUN mkdir -p /etc/s6-overlay/s6-rc.d/homebox-companion \
    && mkdir -p /etc/s6-overlay/s6-rc.d/homebox-companion/dependencies.d \
    && touch /etc/s6-overlay/s6-rc.d/homebox-companion/dependencies.d/homebox \
    && echo "longrun" > /etc/s6-overlay/s6-rc.d/homebox-companion/type \
    && printf '#!/command/execlineb -P\ncd /app\n/app/.venv/bin/python -m server.app\n' > /etc/s6-overlay/s6-rc.d/homebox-companion/run \
    && chmod +x /etc/s6-overlay/s6-rc.d/homebox-companion/run

# --- Reset Cron Service ---
RUN mkdir -p /etc/s6-overlay/s6-rc.d/reset-cron \
    && mkdir -p /etc/s6-overlay/s6-rc.d/reset-cron/dependencies.d \
    && touch /etc/s6-overlay/s6-rc.d/reset-cron/dependencies.d/homebox \
    && echo "longrun" > /etc/s6-overlay/s6-rc.d/reset-cron/type

# Create crontab for 30-minute reset
RUN echo "*/30 * * * * /app/demo/reset-homebox.sh >> /var/log/services/reset.log 2>&1" > /etc/crontab.demo

# Reset cron run script
RUN printf '#!/command/execlineb -P\nsupercronic /etc/crontab.demo\n' > /etc/s6-overlay/s6-rc.d/reset-cron/run \
    && chmod +x /etc/s6-overlay/s6-rc.d/reset-cron/run

# --- Init script to seed demo data on first boot ---
RUN mkdir -p /etc/s6-overlay/s6-rc.d/init-seed \
    && mkdir -p /etc/s6-overlay/s6-rc.d/init-seed/dependencies.d \
    && touch /etc/s6-overlay/s6-rc.d/init-seed/dependencies.d/homebox \
    && echo "oneshot" > /etc/s6-overlay/s6-rc.d/init-seed/type \
    && printf '/app/demo/seed-demo.sh\n' > /etc/s6-overlay/s6-rc.d/init-seed/up \
    && chmod +x /etc/s6-overlay/s6-rc.d/init-seed/up

# Register services with s6
RUN mkdir -p /etc/s6-overlay/s6-rc.d/user/contents.d \
    && touch /etc/s6-overlay/s6-rc.d/user/contents.d/homebox \
    && touch /etc/s6-overlay/s6-rc.d/user/contents.d/homebox-companion \
    && touch /etc/s6-overlay/s6-rc.d/user/contents.d/reset-cron \
    && touch /etc/s6-overlay/s6-rc.d/user/contents.d/init-seed

# Make demo scripts executable
RUN chmod +x /app/demo/*.sh

# =============================================================================
# Environment Variables
# =============================================================================

# Homebox config
ENV HBOX_MODE=production
ENV HBOX_STORAGE_CONN_STRING=file:///?no_tmp_dir=true
ENV HBOX_STORAGE_PREFIX_PATH=data
ENV HBOX_DATABASE_SQLITE_PATH=/data/homebox.db?_pragma=busy_timeout=2000&_pragma=journal_mode=WAL&_fk=1&_time_format=sqlite
ENV HBOX_WEB_PORT=7745
ENV HBOX_OPTIONS_ALLOW_REGISTRATION=true

# Homebox Companion config
ENV HBC_SERVER_HOST=0.0.0.0
ENV HBC_SERVER_PORT=8000
ENV HBC_HOMEBOX_URL=http://localhost:7745
ENV HBC_DEMO_MODE=true
ENV HBC_LOG_LEVEL=INFO

# Demo user credentials (used by seed script)
ENV DEMO_EMAIL=demo@example.com
ENV DEMO_PASSWORD=demo

# =============================================================================
# Final Configuration
# =============================================================================

# Expose both ports:
#   - 7745: Homebox direct access (demo.homebox.duelion.com)
#   - 8000: Homebox Companion (demo.hbcompanion.duelion.com)
EXPOSE 7745 8000

# Health check against homebox-companion
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8000/api/version && wget -q --spider http://localhost:7745/api/v1/status || exit 1

# Use s6-overlay as init
ENTRYPOINT ["/init"]
